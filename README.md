# Flexberry.AsyncOpenXmlReports.Sample
## Система отчетов с использованием асинхронного сервиса Quartz.Net
- Приложение формирует отчеты по запросам пользователей. Для формирования отчетов используется Quartz.Net, благодаря чему отчеты формируются асинхронно и по расписанию. Присутствует возможность загрузки пользовательского шаблона, на основе которого будет строиться отчет.
- В приложении предусмотрена функция уведомления пользователя об окончании операции. Уведомление выполняется сразу двумя способами - через почту (MailKit) и всплывающее окно в интерфейсе клиента (SignalR).

## Стркутура проекта
![image](https://user-images.githubusercontent.com/29531380/235089220-c81c6cd3-63fd-43c3-864b-2f7ae56ec66d.png)

## Пример включает в себя следующие сервисы
- **App**: стандартные odata backend + ember-app приложения;
- **App-postgres-db**: база данных PostgreeSQL;
- **Keycloak**: сервис авторизации польователей;
- **Quartz**: сервис формирования отчетов.

## Сервис App
- Odata Backend;
- Ember-app Frontend;
- Создает SignalR соединения с пользователем через Web Socket для отправки уведомлений о формировании отчетов;
- Принимает запросы на формирование отчетов и отправляет их в сервис Quartz;
- Принимает ответы от сервиса Quartz о завершении формирования отчетов;
- Отправляет почтовые MailKit или SignalR уведомления о завершении формирования отчетов.

### Особенности использования SignalR
![image](https://user-images.githubusercontent.com/29531380/235136156-e0805b73-c90f-4b73-972a-ea4439769659.png)

### Отправка уведомления на почту
![image](https://user-images.githubusercontent.com/29531380/235136268-47855b94-b63e-4803-a214-36cf8f02c2a4.png)
Если нет соединения с пользователем по SignalR, от отправляем уведомление на почту, используя шаблон Т4 или шаблон Razor.

## Сервис App-postgres-db
- База данных приложения;
- База данных полномочий;
- База данных отчетов.

## Сервис Keycloak
- Сервис авторизации пользователей;
- Сервис ролей пользователей;
- Содержит и передает дополнительные данные пользователей, такие как email.

## Сервис Quartz
- Принимает запросы на формирование отчетов от сервиса App;
- Формирует задачи для Quartz.Net, в которых происходит формирование отчетов;
- Отправляет ответы о формировании отчетов в сервис App;
- Отчеты попадают в общее дисковое пространство докера: REPORTS.

![image](https://user-images.githubusercontent.com/29531380/235136352-a4f4f281-4b97-41fd-acec-3bef7714d1dd.png)

### Особенности сервиса Quartz
![image](https://user-images.githubusercontent.com/29531380/235136484-8dff5975-a2f2-4860-920c-eeff9160b4ea.png)
На каждое задание инициализируется свой RoleSecurityManager (ISecurityManager). Его инициализация зависит от параметров запуска отчета в части пользователя и его ролей.

### Построитель DOCX отчетов
- Используется пакет OpenXMLPowerTools.Reports, который представляет из себя доработку базового пакета OpenXmlPowerTools.NetStandard
- Пакет предоставляет более широкий набор функционала по поиску и замене параметров при формировании отчетов.

## Запуск сервисов
- Используем рабочую папку src\Docker
- Собираем докер образы
```create-images.cmd```
- Запускаем сервисы
```start.cmd```
- Добавить в host имя сервиса keycloak
```127.0.0.1 keycloak```
- Приложение доступно по адресу 
```http://localhost```
- Консоль управления keycloak доступна по адресу
```http://keycloak:8080```
- Логин и пароль для доступа к сайту и keycloak
```admin\admin```

Если вы только что все запустили и вас не пускает на сайт, и не открывается http://keycloak:8080, то нужно немного подождать. Сейвису keycloak необходимо некоторое время на запуск (около минуты).
